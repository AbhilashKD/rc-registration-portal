node() {
    withCredentials([string(credentialsId: 'docker_server', variable: 'docker_server')]) {
        properties([
            parameters([
                string(name: 'docker_repo', defaultValue: 'samagragovernance/registration_portal', description: 'Docker Image Name'),
                string(name: 'docker_server', defaultValue: "$docker_server", description: 'Docker Registry URL'),

            ])
        ])
    }
    stage('Checkout') {
            cleanWs()
            checkout scm
            env.commit_id = env.BRANCH_NAME
            echo "${env.commit_id}"
    }

    stage('docker-build') {
        if (env.BRANCH_NAME == 'main' || env.BRANCH_NAME == 'master') {
            sh '''
            docker build -t $docker_server/$docker_repo:main .
            '''
        }
		else if (env.BRANCH_NAME == 'dev') {
			 sh '''
            docker build -t $docker_server/$docker_repo:dev .
            '''
                    } 
		else if (env.BRANCH_NAME == 'uat') {
			 sh '''
            docker build -t $docker_server/$docker_repo:uat .
            '''
                    } 
    }

    stage('docker-push') {
	
        if (env.BRANCH_NAME == 'main' || env.BRANCH_NAME == 'master') {
            sh '''
            docker push $docker_server/$docker_repo:main
            '''
        }
		else if (env.BRANCH_NAME == 'dev') {
			 sh '''
            docker push $docker_server/$docker_repo:dev .
            '''
                    } 
		else if (env.BRANCH_NAME == 'uat') {
			 sh '''
            docker push $docker_server/$docker_repo:uat .
            '''
                    } 
    }

    stage('Start deploy job with latest tag') {
         if (env.BRANCH_NAME == 'main' || env.BRANCH_NAME == 'master') { 
                build job: 'ULP/deploy-staging/deploy-registration-portal', parameters: [string(name: 'tag', value: 'main')]
         }
		 else if (env.BRANCH_NAME == 'dev' ) { 
                build job: 'SBRC-deploy/deploy-services/deploy-staging/deploy-registration-portal', parameters: [string(name: 'tag', value: 'dev')]
         }
		 else if (env.BRANCH_NAME == 'uat' ) { 
                build job: 'UAT/deploy-uat/deploy-registration-portal', parameters: [string(name: 'tag', value: 'uat')]
         }
    }

}